{% extends "base.html" %}
{% block title %}{% if post %}Edit Post{% else %}Write{% endif %} - SJ Home Agent{% endblock %}

{% block content %}
<h1>{% if post %}Edit Post{% else %}New Post{% endif %}</h1>

<form method="post" action="{% if post %}/posts/{{ post.id }}/edit{% else %}/write{% endif %}">
    <div style="margin-bottom: 1rem;">
        <label for="title"><strong>Title</strong></label><br>
        <input type="text" id="title" name="title" value="{{ post.title if post else '' }}"
               style="width: 100%; padding: 0.5rem; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 4px;"
               required>
    </div>

    <div style="margin-bottom: 1rem;">
        <label for="tags"><strong>Tags</strong> <small>(comma-separated)</small></label><br>
        <input type="text" id="tags" name="tags" value="{{ post.tags if post else '' }}"
               style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
               placeholder="tag1, tag2, tag3">
    </div>

    {% if post %}
    <div style="margin-bottom: 1rem;">
        <label for="status"><strong>Status</strong></label><br>
        <select id="status" name="status" style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            <option value="draft" {% if post.status == 'draft' %}selected{% endif %}>Draft</option>
            <option value="published" {% if post.status == 'published' %}selected{% endif %}>Published</option>
        </select>
    </div>
    {% endif %}

    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <div style="flex: 1;">
            <label for="content"><strong>Content</strong> <small>(Markdown)</small></label><br>
            <textarea id="content" name="content"
                      style="width: 100%; height: 400px; padding: 0.5rem; font-family: monospace; font-size: 0.95rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"
                      required>{{ post.content if post else '' }}</textarea>
        </div>
        <div style="flex: 1;">
            <label><strong>Preview</strong></label>
            <div id="preview"
                 style="width: 100%; height: 400px; padding: 0.5rem; border: 1px solid #eee; border-radius: 4px; overflow-y: auto; background: #fafafa;">
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 0.5rem;">
        <button type="submit"
                style="padding: 0.5rem 1.5rem; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
            {% if post %}Save Changes{% else %}Save Draft{% endif %}
        </button>
        {% if post %}
        <a href="/posts" style="padding: 0.5rem 1rem; text-decoration: none; color: #666;">Cancel</a>
        {% endif %}
    </div>
</form>

<script>
(function() {
    var textarea = document.getElementById('content');
    var preview = document.getElementById('preview');

    function renderPreview() {
        var md = textarea.value;
        // Simple markdown rendering
        var html = md
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/`(.+?)`/g, '<code style="background:#eee;padding:0.1em 0.3em;border-radius:3px;">$1</code>')
            .replace(/^> (.+)$/gm, '<blockquote style="border-left:3px solid #ddd;padding-left:1rem;color:#666;">$1</blockquote>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
        preview.innerHTML = html;
    }

    textarea.addEventListener('input', renderPreview);
    renderPreview();
})();
</script>
{% endblock %}
